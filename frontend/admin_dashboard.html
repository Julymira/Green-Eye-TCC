<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Green Eye</title>
    <link rel="stylesheet" href="style.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f4;
            color: #333;
        }

        .navbar {
            background-color: #2e7d32;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar h1 {
            margin: 0;
            font-size: 24px;
        }

        .navbar button {
            background-color: #fff;
            color: #2e7d32;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .navbar button:hover {
            background-color: #e8f5e9;
        }

        .content {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        .stat-card.success {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
        }

        .stat-card h3 {
            font-size: 42px;
            margin: 0 0 10px 0;
        }

        .stat-card p {
            margin: 0;
            font-size: 16px;
            opacity: 0.9;
        }

        /* LAYOUT DE 2 COLUNAS */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .card.full-width {
            grid-column: 1 / -1;
        }

        h2 {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            color: #2e7d32;
            margin-top: 0;
        }

        /* MAPA INTEGRADO */
        #mapaDashboard {
            height: 500px;
            border-radius: 8px;
            margin-top: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th {
            background-color: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }

        .status-Nova {
            background: #ffebee;
            color: #c62828;
        }

        .status-Em-verifica√ß√£o {
            background: #fff3e0;
            color: #e65100;
        }

        .status-Resolvida {
            background: #e8f5e9;
            color: #2e7d32;
        }

        button.action-btn {
            background-color: #2e7d32;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-right: 5px;
        }

        button.action-btn:hover {
            background-color: #1b5e20;
        }

        button.action-btn.resolver {
            background-color: #43a047;
        }

        button.action-btn.localizar {
            background-color: #1976d2;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* Estilo do popup do mapa */
        .leaflet-popup-content {
            min-width: 200px;
        }

        .popup-denuncia h3 {
            margin: 0 0 10px 0;
            color: #2e7d32;
        }

        .popup-denuncia p {
            margin: 5px 0;
        }
    </style>
</head>
<body>

    <header class="navbar">
        <h1>üåø Green Eye - Painel Administrativo</h1>
        <button onclick="logout()">Sair</button>
    </header>

    <main class="content">
        <!-- Estat√≠sticas -->
        <div class="stats-container">
            <div class="stat-card">
                <h3 id="totalNovas">-</h3>
                <p>Den√∫ncias Novas</p>
            </div>
            <div class="stat-card warning">
                <h3 id="totalVerificacao">-</h3>
                <p>Em Verifica√ß√£o</p>
            </div>
            <div class="stat-card success">
                <h3 id="totalResolvidas">-</h3>
                <p>Resolvidas</p>
            </div>
            <div class="stat-card">
                <h3 id="totalGeral">-</h3>
                <p>Total de Den√∫ncias</p>
            </div>
        </div>

        <!-- LAYOUT DE 2 COLUNAS -->
        <div class="main-layout">
            <!-- COLUNA 1: Mapa -->
            <div class="card">
                <h2>üìç Mapa de Den√∫ncias</h2>
                <p style="color: #666; font-size: 14px;">
                    Clique em "Localizar" na tabela para visualizar a den√∫ncia no mapa
                </p>
                <div id="mapaDashboard"></div>
            </div>

            <!-- COLUNA 2: Tabela de Den√∫ncias -->
            <div class="card">
                <h2>Gerenciar Den√∫ncias</h2>
                <div id="loadingIndicator" class="loading">
                    Carregando den√∫ncias...
                </div>
                <div id="tabelaContainer" style="display: none; max-height: 550px; overflow-y: auto;">
                    <table id="tabelaDenuncias">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tipo</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="listaDenuncias">
                        </tbody>
                    </table>
                </div>
                <div id="emptyState" class="empty-state" style="display: none;">
                    <p>‚úÖ Nenhuma den√∫ncia pendente no momento!</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ============================================
        // VARI√ÅVEIS GLOBAIS
        // ============================================
        let map;
        let markersLayer;
        let todasDenuncias = []; // Armazena todas as den√∫ncias carregadas

        // ============================================
        // INICIALIZA√á√ÉO DO MAPA
        // ============================================
        function inicializarMapa() {
            map = L.map('mapaDashboard').setView([-16.2531, -47.9503], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            markersLayer = L.layerGroup().addTo(map);
        }

        // ============================================
        // CARREGAR DADOS DO BACKEND
        // ============================================
        async function carregarDados() {
            try {
                const response = await fetch('/api/reports?status=Nova,Em verifica√ß√£o,Resolvida');
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar den√∫ncias');
                }

                todasDenuncias = await response.json();

                // Calcular estat√≠sticas
                const stats = todasDenuncias.reduce((acc, d) => {
                    const status = d.status || 'Nova';
                    acc[status] = (acc[status] || 0) + 1;
                    acc.total++;
                    return acc;
                }, { total: 0 });

                // Atualizar cards
                document.getElementById('totalNovas').textContent = stats['Nova'] || 0;
                document.getElementById('totalVerificacao').textContent = stats['Em verifica√ß√£o'] || 0;
                document.getElementById('totalResolvidas').textContent = stats['Resolvida'] || 0;
                document.getElementById('totalGeral').textContent = stats.total || 0;

                // Renderizar tabela e mapa
                renderizarTabela();
                renderizarMapa();

            } catch (err) {
                console.error('Erro ao carregar dados:', err);
                document.getElementById('loadingIndicator').innerHTML = 
                    '<p style="color: red;">‚ùå Erro ao conectar com o servidor.</p>';
            }
        }

        // ============================================
        // RENDERIZAR TABELA
        // ============================================
        function renderizarTabela() {
            const denunciasPendentes = todasDenuncias.filter(d => 
                d.status === 'Nova' || d.status === 'Em verifica√ß√£o'
            );

            const loading = document.getElementById('loadingIndicator');
            const tabelaContainer = document.getElementById('tabelaContainer');
            const tbody = document.getElementById('listaDenuncias');
            const emptyState = document.getElementById('emptyState');

            loading.style.display = 'none';

            if (denunciasPendentes.length === 0) {
                emptyState.style.display = 'block';
                tabelaContainer.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                tabelaContainer.style.display = 'block';

                tbody.innerHTML = denunciasPendentes.map(d => {
                    const statusClass = (d.status || 'Nova').replace(' ', '-');
                    
                    return `
                        <tr>
                            <td>#${d.id}</td>
                            <td>${d.tipo_lixo || 'N√£o especificado'}</td>
                            <td><span class="status-badge status-${statusClass}">${d.status || 'Nova'}</span></td>
                            <td>
                                <button class="action-btn localizar" onclick="localizarNoMapa(${d.id}, ${d.lat}, ${d.lng})">
                                    üìç Localizar
                                </button>
                                ${d.status === 'Nova' ? 
                                    `<button class="action-btn" onclick="alterarStatus(${d.id}, 'Em verifica√ß√£o')">
                                        ‚ö†Ô∏è Verificar
                                    </button>` 
                                    : ''
                                }
                                ${d.status === 'Em verifica√ß√£o' ? 
                                    `<button class="action-btn resolver" onclick="alterarStatus(${d.id}, 'Resolvida')">
                                        ‚úÖ Resolver
                                    </button>` 
                                    : ''
                                }
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }

        // ============================================
        // RENDERIZAR MAPA
        // ============================================
        function renderizarMapa() {
            // Limpar marcadores existentes
            markersLayer.clearLayers();

            // Adicionar todas as den√∫ncias ao mapa
            todasDenuncias.forEach(d => {
                // √çcone customizado por status
                const iconUrl = d.status === 'Resolvida' 
                    ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png'
                    : d.status === 'Em verifica√ß√£o'
                    ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png'
                    : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png';

                const icon = L.icon({
                    iconUrl: iconUrl,
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34]
                });

                const marker = L.marker([d.lat, d.lng], { icon: icon });
                
                const popupContent = `
                    <div class="popup-denuncia">
                        <h3>#${d.id} - ${d.tipo_lixo || 'N√£o especificado'}</h3>
                        <p><strong>Status:</strong> ${d.status || 'Nova'}</p>
                        <p><strong>Quantidade:</strong> ${d.quantidade || '-'}</p>
                        ${d.descricao_adicional ? 
                            `<p><strong>Descri√ß√£o:</strong> ${d.descricao_adicional}</p>` 
                            : ''
                        }
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.addTo(markersLayer);
            });
        }

        // ============================================
        // LOCALIZAR DEN√öNCIA NO MAPA
        // ============================================
        function localizarNoMapa(id, lat, lng) {
            // Centralizar no mapa
            map.setView([lat, lng], 17);
            
            // Abrir popup do marcador correspondente
            markersLayer.eachLayer(layer => {
                if (layer.getLatLng().lat === lat && layer.getLatLng().lng === lng) {
                    layer.openPopup();
                }
            });

            // Destacar visualmente (opcional: piscar o marcador)
            // Scroll suave at√© o mapa
            document.getElementById('mapaDashboard').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        }

        // ============================================
        // ALTERAR STATUS
        // ============================================
        async function alterarStatus(id, novoStatus) {
            if (!confirm(`Alterar status para "${novoStatus}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/reports/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: novoStatus })
                });

                if (response.ok) {
                    alert('‚úÖ Status atualizado com sucesso!');
                    carregarDados(); // Recarrega tudo
                } else {
                    const erro = await response.json();
                    alert('‚ùå Erro: ' + (erro.error || 'N√£o foi poss√≠vel atualizar'));
                }
            } catch (err) {
                console.error('Erro:', err);
                alert('‚ùå Erro de conex√£o ao tentar atualizar o status');
            }
        }

        // ============================================
        // LOGOUT
        // ============================================
        function logout() {
            if (confirm('Deseja realmente sair?')) {
                alert('Voc√™ foi desconectado.');
                window.location.href = '/login.html';
            }
        }

        // ============================================
        // INICIALIZA√á√ÉO
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            inicializarMapa();
            carregarDados();
            
            // Atualiza a cada 30 segundos
            setInterval(carregarDados, 30000);
        });
    </script>

</body>
</html>